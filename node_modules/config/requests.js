var request = require('request');
var mysql = require('mysql');

var connection = mysql.createConnection(
    {
      host     : 'localhost',
      user     : 'root',
      password : '1234',
      database : 'node_test'
    }
);
connection.connect();
/*
exports.tmpfunc = function(callback){

	var que = "INSERT into users(name, mobno, reg_id) values('test_name',1231231,'test_id')";
	var query = connection.query(que, function(err, rows){
		if(!err){callback({'response':"Successfully"});}
		else{callback({'response':"Error"});}
});

}
*/
/*

exports.login = function(name,mobno,reg_id,callback) {

var data = {
            
            name    : name,
            mobno :  mobno,
            reg_id   : reg_id
            
        
        };
var que = "SELECT * from users WHERE reg_id =" + reg_id;

 var query = connection.query(que, function(err, rows)
        {
          if(rows.length == 0){
            var query = connection.query("INSERT INTO users set ? ",data, function(err, rows)
        {
  
          callback({'response':"Sucessfully Registered"});
    
        });
          }else {

           callback({'response':"User already Registered"});

          }
      
        });
    

}

*/
/*
exports.getuser = function(reg_id,callback) {



 var query = connection.query("SELECT * from users", function(err, rows)
        {
          if(rows.length == 0){
            callback({'response':"No Users Registered"});
          }else {

          callback(removeUser(rows, mobno));

          }
      
        });

}


exports.removeuser = function(mobno,callback) {

var que = "DELETE FROM users  WHERE mobno =" + mobno;

var query = connection.query(que, function(err, rows)
        {
            
             if(!err){

    callback({'response':"Removed Sucessfully"});
  }else{
    callback({'response':"Error"});
  }  
        });
}


*/

exports.signup = function(token, userID, userPW, callback){

  var que = "INSERT into tmp_user(token, userID, userPW) values('"+token+"', '"+userID+"', '"+userPW+"')";

  var query = connection.query(que, function(err, rows){
    if(rows.length == 0){
      callback({'response':"Failure"});
    }
    else{
      request(
              { 
                method: 'POST', 
                uri: 'https://gcm-http.googleapis.com/gcm/send',
                headers: {
                  'Content-Type': 'application/json;charset=utf-8',
                  'Authorization':'key=AIzaSyD3J25x-aFTX7NazW6w8kZPatWuQaz0-rk'
                  //APIKEYÀÔ·Â
                },
                body: JSON.stringify({
                  "registration_ids" : [token],
                  "data" : {
                    "title":"Sign-up complete!",
                    "partner":"asdf1234"
                  },
                "time_to_live": 108
                })
              }
              , function (error, response, body) {
                callback({'response':"Success" + "/ " + msg});
              }
          )

    }

  })


}
exports.send = function(from_id, to_id, msg, time_msg, callback){

  //var que = "SELECT * from users WHERE reg_id ='" + to_id+"'";
  var que = "SELECT * from tmp_user WHERE token = '" + to_id+"'"; 
  //console.log(que);
  var query = connection.query(que, function(err, rows){
    if(rows.length == 0){
      callback({'response':"Failure"});
    }
    else{
      var que  = "INSERT INTO testDB(cli_reg_id, par_reg_id, log, time_message) VALUES('"+from_id+"', '" + to_id +"', '" + msg + "', '" + time_msg + "')" ; 

      //console.log(que);
      var query = connection.query(que, function(err, rows){
        //console.log('row2:'+rows+err);
        if(rows.length == 0){
          console.log('err test');
          callback({'response':"Failure"});
        }
        else{

          request(
              { 
                method: 'POST', 
                uri: 'https://gcm-http.googleapis.com/gcm/send',
                headers: {
                  'Content-Type': 'application/json;charset=utf-8',
                  'Authorization':'key=AIzaSyD3J25x-aFTX7NazW6w8kZPatWuQaz0-rk'
                  //APIKEYÀÔ·Â
                },
                body: JSON.stringify({
                  "registration_ids" : [to_id],
                  "data" : {
                  "msg":msg,
                  "from_id":from_id,
                  "to_id":to_id,
                  "time_msg":time_msg
                  },
                "time_to_live": 108
                })
              }
              , function (error, response, body) {
                callback({'response':"Success" + "/ " + msg});
              }
          )
        }
      });
    }
  });
}

/*
exports.send = function(fromn,fromu,to,msg,callback) {

var que = "SELECT * from users WHERE reg_id =" + to;

 var query = connection.query(que, function(err, rows)
        {
          if(rows.length == 0){
            callback({'response':"Failure"});
        
          }else {

           
	var to_id = rows[0].reg_id;
	var name = rows[0].name;

request(
    { method: 'POST', 
    uri: 'https://gcm-http.googleapis.com/gcm/send',
    headers: {
        'Content-Type': 'application/json;charset=utf-8',
        'Authorization':'key=AIzaSyAxK6wsn12YK7iN6s7PG_AJePcT6E8PxmU'
    },
    body: JSON.stringify({
  "registration_ids" : [to_id],
  "data" : {
    
    "msg":msg,
    "fromu":fromu,
    "name":fromn
  },
  "time_to_live": 108
})
    }
  , function (error, response, body) {

	  callback({'response':"Success" + "/ " + msg});
    }
  )
}});

}
*/

/*    
exports.EnterRoom = function(from_id, to_id, index, callback){
 
  var que = "SELECT * from testDB WHERE " +" limit "+index +" "+index+6 +"order by time_message desc" ;

  var query = connection.query(que, function(err, rows){
    if(rows.length == 0){
      callback({'response':"Failure"});
    }
    else{
      var msg  =  new Array();
      var sender = new Array();
      var time_msg = new Array();
      for(var i=0;i<6;i++){
        msg[i] = rows[i].log;
        sender[i] = rows[i].cli_reg_id;
      }
      // request(
      //     { 
      //       method: 'POST', 
      //       uri: 'http://localhost:8080/test',
      //       headers: {
      //         'Content-Type': 'application/json;charset=utf-8',
      //         'Authorization':'key=AIzaSyAxK6wsn12YK7iN6s7PG_AJePcT6E8PxmU'
      //         //APIKEYÀÔ·Â
      //       },
      //       body: JSON.stringify({
      //         "registration_ids" : [to_id],
      //         "data" : {
      //           "msg":msg,
      //           "sender":sender,
      //           "time_msg":time_msg
      //         },
      //       "time_to_live": 108
      //       })
      //     }
      //     , function (error, response, body) {
      //       callback({'response':"Success" + "/ " + msg});
      //     }
      // )

      request(
          { 
            method: 'POST', 
            uri: 'https://gcm-http.googleapis.com/gcm/send',
            headers: {
              'Content-Type': 'application/json;charset=utf-8',
              'Authorization':'key= AIzaSyD3J25x-aFTX7NazW6w8kZPatWuQaz0-rk'
              //APIKEYÀÔ·Â
            },
            body: JSON.stringify({
              "registration_ids" : [to_id],
              "data" : {
                "msg":msg,
                "sender":sender,
                "time_msg":time_msg
              },
            "time_to_live": 108
            })
          }
          , function (error, response, body) {
            callback({'response':"Success" + "/ " + msg});
          }
      )
    }
  });
}

 */

// function removeUser(arr, val) {
//     for(var i=0; i<arr.length; i++) {
//         if(arr[i].mobno == val) {
//             arr.splice(i, 1);
//             return arr;
//             break;
//         }
//     }
// }

