var request =  require('request');
var mysql = require('mysql');
//DB connection
var connection = mysql.createConnection(
    {
      host     : 'localhost',
      user     : 'root',
      password : '1234',
      database : 'node_test'
    }
);
connection.connect();
//Function for Sign up
//parameter -> token(Registration ID), userID , userPW(password)
//after write on DB , response data meaning 'yes'
exports.signup = function(token, userID, userPW, name, sex, callback){
//exports.signup = function(token, userID, userPW, callback){

  //var que = "INSERT into tmp_user(token, userID, userPW) values('"+token+"', '"+userID+"', '"+userPW+"')";
  //query for newest DB
  var que = "INSERT INTO tmp_client(id, pw, name, sex, token) VALUES('" + userID +"', '" +userPW+"', '" + name +"', '" + sex "', '" + token +"')"; 

  var query = connection.query(que, function(err, rows){
    if(rows.length == 0){
      callback({'response':"Failure"});
    }
    else{
      callback({'result':"Y"});
    }
  })
}
//Function for send message
//parameter -> no_log(index of chat room), time_message(time when message was sent)
//log(message), log_from(who send message e.g. client or partner), device(iphone or android)
//After write DB , Send data to GCM server using json and post method
exports.send = function(no_log, from_id, msg, to_id, time_msg, device, callback){
//exports.send = function(no_log, from_id, msg, to_id, time_msg, callback){
  var no = parseInt(1);
  //var que = "SELECT * from users WHERE reg_id ='" + to_id+"'";
  //searching with token(reg_id)
  //var que = "SELECT * from tmp_user WHERE token = '" + to_id+"'"; 
  //searching with client id
  var que = "SELECT token FROM tmp_client WHERE id='" + to_id + "'";
  console.log(que);
  var query = connection.query(que, function(err, rows){
    if(rows.length == 0){
      callback({'response':"Failure"});
    }
    else{
    	
      var token = rows[0].token;
      var que = "SELECT no FROM log_counseling WHERE no_log="+no_log+"order by id limit 1";

      var query = connection.query(que, function(err, rows){
        if(rows.length == 0){
          no=parseInt(1);
        }
        else{
          no = parseInt(rows[0].no) +parseInt(1);
        }

      });
      //var que  = "INSERT INTO tmp_log(no_log, cli_reg_id, par_reg_id, log, time_message) VALUES("+no_log+", '"+from_id+"', '" + to_id +"', '" + msg + "', '" + time_msg + "')" ; 
      //query for newest db
      var que = "INSERT INTO log_counseling(no_log, no, time_message, log, log_from, device) VALUES("+ no_log+", "+no+", '"+time_message+"', '" + msg +"', '" + from_id +"', '" + device +"')";

      console.log(que);
      var query = connection.query(que, function(err, rows){
        //console.log('row2:'+rows+err);
        if(rows.length == 0){
          console.log('err test');
          callback({'response':"Failure"});
        }
        else{

          request(
              { 
                method: 'POST', 
                uri: 'https://gcm-http.googleapis.com/gcm/send',
                headers: {
                  'Content-Type': 'application/json;charset=utf-8',
                  'Authorization':'key=AIzaSyCiZjmiUXUqstsUyR63pKTYtq59Go_-KmI'
                  //APIKEYÀÔ·Â
                },
                body: JSON.stringify({
                  //"registration_ids" : [to_id],
                  "registration_ids" : [token],
                  "data" : {
                  "msg":msg,
                  "from_id":from_id,
                  "to_id":to_id,
                  "time_msg":time_msg
                  },
                "time_to_live": 108
                })
              }
              , function (error, response, body) {
                callback({'response':"Success" + "/ " + msg});
              }
          )
        }
      });
    }
  });
}
//Function for load message
//parameter-> index(first time index is 0, and it increment e.g.6 ->12->18 it handle on client)=no,
//no_log(index of chat room)
//this function load 6 msg each event
exports.loadmsg = function(index, no_log, callback){
  var i_var=parseInt(index)+parseInt(6);
  //query for newest DB
  var que = "SELECT * FROM log_counseling WHERE no_log = " + no_log +" ORDER BY id desc limit " + index +", " + i_var;
 
  //var que = "SELECT * FROM tmp_log WHERE no_log = " +no_log+" ORDER BY id desc limit "+ index + ", " +i_var;
  console.log(que);
  var query = connection.query(que, function(err, rows){
      if(rows.length == 0 ){
        callback({'response':"Failure"})
      }
      else{
        callback(rows);
      }
  });
//Function for makechat
//parameter
//this function occur when the chat room was established first time and write basic date on DB
exports.makechat = function(time_start, partner, client){
  var que = "INSERT INTO counseling_log(time_start, partner,client) VALUES('"+time_start+"','"+partner+"', '"+client+"')";

  var query =  connection.query(que, function(err, rows){
      if(err){
          callback({'response':"Failure"});
      }
      else{
          var que = "SELECT no FROM counseling_log WHERE time_start='"+time_start+"' and partner='"+partner+"' and client='"+client"'";
          var query = connection.query(que, function(err, rows){
            if(rows.length == 0){
                callback({'response':"Failure"});
            }
            else{
              var no_log = rows[0].no;
              callback({'no_log':no_log});
            }
          });
          
      }
  });

}



